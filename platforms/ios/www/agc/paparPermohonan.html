<!DOCTYPE HTML>
<html>
    <head>
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
		<title>AGC CAMS</title>
        <link rel="stylesheet" href="materialize/css/materialize.min.css" />
        <link rel="stylesheet" href="css/DateTimePicker.css" >
        <link rel="stylesheet" href="css/custom.css" >
		<script src='js/jquery2.1.0.min.js'></script>
        <script src="js/DateTimePicker.js"></script>
        <script src="js/custom.js"></script>
        <script src="materialize/js/materialize.min.js"></script>
		<!-- <script src="js/cams_script.js"></script> -->
		
		
    </head>

    <body>
    	<!-- <script src="../cordova.js"></script> -->
    	
		<script>
		    function reload_js(src) {
		    	//alert('masukkan ' + src + ' melalui script');
		        $('script[src="' + src + '"]').remove();
		        $('<script>').attr('src', src).appendTo('head');
		        //alert('masukkan ' + src + ' melalui script BERJAYA');
		    }

		    
		    function reload2body_js(src) {
		    	//alert('masukkan ' + src + ' melalui script');
		        $('script[src="' + src + '"]').remove();
		        $('<script>').attr('src', src).appendTo('body');
		        //alert('masukkan ' + src + ' melalui script BERJAYA');
		    }

		    reload2body_js('../cordova.js?cachebuster='+ new Date().getTime());
		    reload_js('js/cams_script.js?cachebuster='+ new Date().getTime());
		</script>
    	
        <div class="navbar-fixed">
            <nav class="deep-purple darken-1">
                <div class="nav-wrapper">
                    <div class="input-field">
                        <a href="" onclick="backPage()"><i class="mdi-navigation-chevron-left myBack"></i></a>
                        <img class="nav-logo" src="img/nav-logo.svg">
                        <label>Maklumat Permohonan</label>
                    </div>
                    <a href="#" data-activates="mobile-demo" class="button-collapse right"><i class="mdi-navigation-menu"></i></a>
                    <ul class="side-nav" id="mobile-demo">
                        <li class="profile-container"><div class="profile-background"></div><span class="profile-pic"></span>
						<span id="span_nama" name="span_nama" style="top: calc(50% - 10px);" class="profile-name"></span></li>
                        <li><a href="dashboard.html"><i class="mdi-action-home left"></i>Dashboard</a></li>
                        <li><a href="panduan.html"><i class="mdi-action-description left"></i>Panduan</a></li>
                        <li><a href="konfigurasi.html"><i class="mdi-action-settings left"></i>Konfigurasi</a></li>
                        <li><a href="javascript:;" onclick="logKeluar();"><i class="mdi-action-lock left"></i>Log Keluar</a></li>
                    </ul>
                    <ul class="side-nav hide-on-med-and-down tablet-nav">
                        <li class="profile-container"><div class="profile-background"></div><span class="profile-pic"></span>
						<span id="span_nama" name="span_nama" style="top: calc(50% - 10px);" class="profile-name"></span></li>
                        <li><a href="dashboard.html"><i class="mdi-action-home left"></i>Dashboard</a></li>
                        <li><a href="panduan.html"><i class="mdi-action-description left"></i>Panduan</a></li>
                        <li><a href="konfigurasi.html"><i class="mdi-action-settings left"></i>Konfigurasi</a></li>
                        <li><a href="javascript:;" onclick="logKeluar();"><i class="mdi-action-lock left"></i>Log Keluar</a></li>
                    </ul>
                </div>
            </nav>
        </div>

        <div class="myContainer"> 
            <div class="row">
                <div class="col s12">
                    <div class="card-panel myTitle">Permohonan Kebenaran Meninggalkan Pejabat Dalam Waktu Bekerja di Bawah Perintah AM 5 BAB G</div>
                    <div class="card-panel">
                        <form id="applicantdetail" name="applicantdetail" action="#">
                        
                            <span class="profile-pic-applicant" id="profile-pic-applicant" name="profile-pic-applicant"></span>
                            
                            <div class="row">
                                <div class="col s12 m2 label-on-small-only">Bahagian</div>
                                <div id="bahagian" name="bahagian" class="col s12 m5"></div>
                            </div>
                             
                            <div class="row">
                                <div class="col s12 m2 label-on-small-only">Tujuan</div>
								<div id="tujuan" name="tujuan" type="text" class="col s12 m5"></div>
                            </div>
                            <div class="row">
                                <div class="col s12 m2 label-on-small-only">Tarikh</div>
                                <div id="tkh_keluar" name="tkh_keluar" type="text" class="col s12 m5"></div>
                            </div>
                            <div class="row">
                                <div class="col s12 m2 label-on-small-only">Masa Keluar</div>
								<div id="masa_keluar" name="masa_keluar" type="text" class="col s12 m5"></div>
                            </div>
                            <div class="row">
                                <div class="col s12 m2 label-on-small-only">Masa Masuk</div>
								<div id="masa_masuk" name="masa_masuk" type="text" class="col s12 m5"></div>
                            </div>
                            
                            <div class="row">
                                <div class="col s12 m2 label-on-small-only">Lampiran</div>
                                <div class="col s12 m5 file-field">
                                    <input class="file-path" type="text" disabled/>
                                    <div class="btn waves-effect waves-light deep-purple darken-1">
                                        <span><i class="mdi-editor-attach-file"></i></span>
                                        <input type="file" disabled/>
                                    </div>
                                </div>
                            </div>


                      <div class="card-panel">
							<div id="penyokong" name="penyokong" class="row">
                                <div class="col s12 m2 label-on-small-only">Penyokong</div>
                                <div id="nama_penyokong" name="nama_penyokong" class="col s12 m5"></div>
                            </div>
							<div id="penyokong" name="penyokong" class="row">
                                <div class="col s12 m2 label-on-small-only">Tarikh</div>
                                <div id="tarikh_sokongan" name="tarikh_sokongan" class="col s12 m5"></div>
                            </div>
							<div id="penyokong" name="penyokong" class="row">
                                <div class="col s12 m2 label-on-small-only">Ulasan Penyokong</div>
                                <div id="ulasan_penyokong" name="ulasan_penyokong" class="col s12 m5"></div>
                            </div>
                      </div>
                      <div class="card-panel">      
							<div id="pelulus" name="pelulus" class="row">
                                <div class="col s12 m2 label-on-small-only">Pelulus</div>
                                <div id="nama_pelulus" name="nama_pelulus" class="col s12 m5"></div>
                            </div> 
							<div id="pelulus" name="pelulus" class="row">
                                <div class="col s12 m2 label-on-small-only">Tarikh</div>
                                <div id="tarikh_kelulusan" name="tarikh_kelulusan" class="col s12 m5"></div>
                            </div>
							<div id="pelulus" name="pelulus" class="row">
                                <div class="col s12 m2 label-on-small-only">Ulasan Pelulus</div>
                                <div id="ulasan_pelulus" name="ulasan_pelulus" class="col s12 m5"></div>
                            </div>
                      </div>      
                            
                      <div class="card-panel">   
							<div class="row">
                                <div class="col s12 m2 label-on-small-only">Status Permohonan</div>
								<div id="status_permohonan" name="status_permohonan" type="text" class="col s12 m5"></div>
							</div>
					  </div>      
                      
                            <div id="change-btn" name="change-btn" class="row">
                                <div class="col s12 offset-m2 m10">   
									<button id="update-btn" class="btn-large waves-effect waves-light deep-purple darken-1 fullwidth" type="button" name="action" onclick="kemaskiniPermohonan(gup('phid'));">KEMAS KINI</button>
									&nbsp;&nbsp;  <button id="cancel-btn" class="btn-large waves-effect waves-light deep-purple darken-1 fullwidth" type="button" name="action" onclick="showConfirmBatal();">BATAL PERMOHONAN</button>
									&nbsp;&nbsp;  <button id="checkin-btn" class="btn-large waves-effect waves-light deep-purple darken-1 fullwidth" type="button" name="action" onclick="checkInByApplicant(gup('phid'));">CHECK-IN</button>
								</div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div id="dtBox"></div>
		<span id="hidden1"><input id="stf_username" name="stf_username" type="text"></span>
		<span id="hidden1"><input id="latitud" name="latitud" type="text"></span>
		<span id="hidden1"><input id="longitud" name="longitud" type="text"></span>
		
		<span id="hidden1"><input id="latitud4pelulus" name="latitud4pelulus" type="text"></span>
		<span id="hidden1"><input id="longitud4pelulus" name="longitud4pelulus" type="text"></span>
		
		
		    <script>
            $(document).ready(function(){

            	document.addEventListener("backbutton", function(e){
		        	//if (!GLOBAL_MASUKLISTING)
		        	//	{
		        	//	logKeluar();
		        	//	}
		        	//else
		        	//	{
		        	//	closeListing();
		        	//	}
		        	//history.back();
		        	window.location.href="dashboard.html?nextpage=permohonan";
				 }, false);
		        
            	
            	 if (navigator.notification) { // Override default HTML alert with native dialog
	        	      window.alert = function (message) {
	        		  		navigator.notification.alert(
	        	              message,    // message
	        	              null,       // callback
	        	              "CAMS-AGC", // title
	        	              'OK'        // buttonName
	        	          );
	        	      };
	        	  }
            	 
					$(".button-collapse").sideNav({edge:'right'});
					
					//alert('1');
					getData();
					
					//alert('2');
					getApprover(getSessionStorage("PEN_BHGN_ID"));
					//alert('3');
					getDetailApplicationById (); 
					//alert('4');
					
					var today = new Date();

					$("#dtBox").DateTimePicker({timeFormat:'HH:mm', setButtonContent:'Set', clearButtonContent:'Padam', titleContentTime:'MASA', titleContentDate:'TARIKH', 
					  minDate: today.getDate()+'-'+(today.getMonth()+1)+'-'+today.getFullYear()
					}); //end dateTimePicker()

					
					//alert("cari koordinat sebenar!");	
			        navigator.geolocation.getCurrentPosition(onSuccess, onError);
				   		
			});  //end document ready state
			          
			function getData()
			{
			
				var getFlowID = getSessionStorage("FLOW_ID");
			    if (getFlowID == 2) 
					{
			    		$("#penyokong").show();$("#status_penyokong").show();$("#ulasan_penyokong").show();
						//alert('pengguna ini ada penyokong'); //ajax response successful alert box shows
						getSupporter(getSessionStorage("PEN_BHGN_ID"));
						
					}
					else 
					{
						$("#penyokong").hide();
						$("#status_penyokong").hide();
						$("#ulasan_penyokong").hide();
					} 
					
				$('#span_nama').html (getSessionStorage("STF_NAMA"));
				$('#stf_username').val (getSessionStorage("STF_USERNAME"));
				//$('#phid').val (getSessionStorage("PH_ID"));
				$('#bahagian').html (getSessionStorage("BAHAGIAN"));
										
			
				var nicefilename = getSessionStorage("STF_GAMBAR_FILE");
				//alert(nicefilename);
				var urlgambar = "https://ilms.agc.gov.my/hrm/img/photos/" + nicefilename;
				$('.profile-background').css('background-image', 'url(' + urlgambar + ')');
				$('.profile-pic').css('background-image', 'url(' + urlgambar + ')');	
			}
			
		    		    
			function getSupporter(bhgnid) 
			{
         		//alert('start getSupporter 1');
         		//loading ("Sila tunggu...");
         		
         		//alert('start getSupporter 2');
				var TX = Math.random(); 
		        //start ajax request
                $.ajax({
                    url: GLOBAL_IP + "/api_generator.php?api_name=get_supporter_by_divisionid&TX=" + TX,
                    dataType: "json",
					data: 
					{
						bahagianid: bhgnid
					},
					cache: false,
					timeout: 15 * 1000,
					error: function(xhr, textStatus, errorThrown){
						//alert('connection error ' + textStatus +  errorThrown ); 
						//unloading();
						alertError(1);
						return false;
					},
                    success: function(data) {
						
						var json = $.parseJSON(data);
						//alert('3='+ json.data);
						var jsondata = $.parseJSON(json.data);
						
						var mytext = '<option value="" selected> Sila Pilih </option>';
						for(var i =0; i < jsondata.length; i++)		
						{
							mytext = mytext + '<option value="' + jsondata[i].STF_ID + '">' + jsondata[i].STF_NAMA + '</option>';
							
						}
												
						$('#stf_id_penyokong').html(mytext);
                        $('#stf_id_penyokong').material_select();						
                       // unloading();	
							
                    }
                });
			
        }   
		
		
		function getApprover(bhgnid) 
		{
				//loading("Sila tunggu...");
         		//alert('start');
				var TX = Math.random(); 
		        //start ajax request
                $.ajax({
                    url: GLOBAL_IP + "/api_generator.php?api_name=get_approver_by_divisionid&TX=" + TX,
                    dataType: "json",
					data: 
					{
						bahagianid: bhgnid
					},
					cache: false,
					timeout: 15 * 1000,
					error: function(xhr, textStatus, errorThrown){
						//alert('connection error ' + textStatus +  errorThrown ); 
						//unloading();
						alertError(1);
						return false;
					},
                    success: function(data) {
 
						var json = $.parseJSON(data);
						//alert('3='+ json.data);
						var jsondata = $.parseJSON(json.data);
						
						var mytext = '<option value="" selected> Sila Pilih </option>';
						for(var i =0; i < jsondata.length; i++)		
						{
							mytext = mytext + '<option value="' + jsondata[i].STF_ID + '">' + jsondata[i].STF_NAMA + '</option>';
							
						}
												
						$('#stf_id_pelulus').html(mytext);
                        $('#stf_id_pelulus').material_select();						
                        //unloading();								
                    }
                });
			
        }   //end getApprover()
		
				
		function getDetailApplicationById () 
		{
        		//loading ("Sila tunggu...");
         		var TX = Math.random(); 
				
				//alert("nilai gup phid = " + gup("phid"));
                $.ajax({
                    url: GLOBAL_IP + "/api_generator.php?api_name=get_detail_application_by_id&TX=" + TX,
                    dataType: "json",
					data: 
					{
						id: gup("phid")
					},
					cache: false,
					timeout: 15 * 1000,
					error: function(xhr, textStatus, errorThrown){
						//alert('connection error ' + textStatus +  errorThrown ); 
						//unloading();
						alertError(1);
						return false;
					},
                    success: function(data) {
					    //alert('Success');
					    var json = $.parseJSON(data);
						var jsondata = $.parseJSON(json.data);
						//alert(jsondata);	
						 //unloading();
						 
						if (jsondata.length > 0) {
							var phid=jsondata[0].PH_ID;
							var nama_penyokong = jsondata[0].STF_NAMA_PENYOKONG;	
							var ulasan_penyokong = jsondata[0].PH_KOMEN_PENYOKONG;
							var nama_pelulus = jsondata[0].STF_NAMA_PELULUS;
							var ulasan_pelulus = jsondata[0].PH_KOMEN_PELULUS;							
							var tarikh = jsondata[0].PH_TKH_KELUAR;
								tarikh = tarikh.replace ("/","-");
								tarikh = tarikh.replace ("/","-");
							var tarikh_sokongan = jsondata[0].PH_TKH_STATUS_PENYOKONG;
								tarikh_sokongan = tarikh_sokongan.replace ("/","-");
								tarikh_sokongan = tarikh_sokongan.replace ("/","-");
							var tarikh_kelulusan = jsondata[0].PH_TKH_STATUS_PELULUS;
								tarikh_kelulusan = tarikh_kelulusan.replace ("/","-");
								tarikh_kelulusan = tarikh_kelulusan.replace ("/","-");
							var sebab = jsondata[0].PH_TUJUAN;
							var masa_keluar = jsondata[0].PH_MASA_KELUAR;
							var masa_masuk = jsondata[0].PH_MASA_MASUK;
							var status_permohonan = jsondata[0].STATUS_PERMOHONAN;
							var status_id_penyokong = jsondata[0].PH_STATUS_ID_PENYOKONG;
							var status_id_permohonan = jsondata[0].PH_STATUS_ID_PERMOHONAN;
							var bf_flow_id = jsondata[0].PH_BF_FLOW_ID;
							var lat = jsondata[0].PH_LATITUD_CHECK_IN;
							var lng = jsondata[0].PH_LONGITUD_CHECK_IN;
							lat = lat.trim();
							lng = lng.trim();
							
							var STF_GAMBAR_FILE_PEMOHON = jsondata[0].STF_GAMBAR_FILE_PEMOHON;
							var nicefilename=encodeURIComponent(STF_GAMBAR_FILE_PEMOHON); 
						    var urlgambar = "https://ilms.agc.gov.my/hrm/img/photos/" + nicefilename;
						    $('#profile-pic-applicant').css('background-image', 'url(' + urlgambar + ')');
						    
						   
						    
							if (bf_flow_id == "1")
							{
								if (status_id_permohonan==4){ //belum diluluskan
									$("#update-btn").show();
									$("#cancel-btn").show();
									$("#checkin-btn").hide();
								}
								else
								{
									$("#update-btn").hide();
									$("#cancel-btn").show();
									$("#checkin-btn").show();
								}
                         
							}
							else // 2level
							{
								if (status_id_permohonan==1){ //belum disokong
									//$("#change-btn").show();
									$("#update-btn").show();
									$("#cancel-btn").show();
									$("#checkin-btn").hide();
								}
								else
								{
									//$("#change-btn").hide();
									$("#update-btn").hide();
									$("#cancel-btn").show();
									$("#checkin-btn").show();
								}
							
							}
							
							if (status_id_permohonan==3 || status_id_permohonan==6 || status_id_permohonan==8){ //control permohonan. Tidak boleh 
																					//edit jika tidak lulus (6) / tidak disokong (3)  / dibatalkan (3)
								$("#change-btn").hide();
							
							}
							else if (status_id_permohonan==4 || status_id_permohonan=="" ){
							  $("#update-btn").show();
							  $("#cancel-btn").show();
							  $("#checkin-btn").hide();
							}
							else if (status_id_permohonan==5){
							  $("#update-btn").hide();
							  $("#cancel-btn").show();
							  $("#checkin-btn").show();
							} 						
						   
							/*
						   if (lat!="" && lng!="" && status_id_permohonan==5 ){  //hide check-in button once pinned location.
						   // means all buttons are hidden. $("#checkin-btn").hide();
								$("#change-btn").hide();
								$("#update-btn").hide();
								$("#cancel-btn").hide();
								$("#checkin-btn").hide();
						   } 
						   */
                         
						 $('#nama_penyokong').html(nama_penyokong);
						 $('#ulasan_penyokong').html(ulasan_penyokong);
						 $('#nama_pelulus').html(nama_pelulus);
						 $('#ulasan_pelulus').html(ulasan_pelulus);
						 $('#tkh_keluar').html(tarikh);
						 $('#tarikh_sokongan').html(tarikh_sokongan);
						 $('#tarikh_kelulusan').html(tarikh_kelulusan);
						 $('#masa_keluar').html(masa_keluar);
						 $('#masa_masuk').html(masa_masuk);
						 $('#tujuan').html(sebab);
						 $('#status_permohonan').html(status_permohonan);
						 $('#latitud4pelulus').val(lat);
						 $('#longitud4pelulus').val(lng);
													
                         }
					
					}
                });
			
        }   
		
		function kemaskiniPermohonan(phid)
		{
				//alert('saya di kemaskiniPermohonan');
				window.location.href = "kemaskinipermohonan.html?phid=" + phid;
		} 
		

      function showConfirmBatal() {
				
        	navigator.notification.confirm(
    			    "Adakah anda pasti untuk membatalkan permohonan ini?",  // message
    		        onConfirmBatal,                // callback to invoke with index of button pressed
    		        "CAMS-AGC", // title
    		        'YA,TIDAK'          // buttonLabels
    		    );
   	
        }

        
        function onConfirmBatal(buttonIndex) {
            //alert('You selected button ' + buttonIndex);
            if (buttonIndex == 1)
            	{
            	cancelApplication();	
            	}
            
        }
		
		
		function cancelApplication(){
		
			loading("Permohonan anda sedang dibatalkan. Sila tunggu...");	
			var TX = Math.random(); 
		        //start ajax request
                $.ajax({
                    url: GLOBAL_IP + "/api_generator.php?api_name=cancel_application_by_applicant&TX=" + TX,
                    dataType: "json",
					data: 
					{
						ph_id: gup("phid"),
						stf_username: getSessionStorage("STF_USERNAME")
					},
					cache: false,
					timeout: 15 * 1000,
					error: function(xhr, textStatus, errorThrown){
						//alert('connection error ' + textStatus +  errorThrown ); 
						unloading();
						alertError(1);
						return false;
					},
                    success: function(data) {
                    	
                    	unloading();
                    	alert ('Permohonan anda telah dibatalkan.\nTerima kasih.');
                    	window.location.href = "dashboard.html";    					
													
                    }
                });
		
		}
		
        //Tracking Location by using cordova-plugin-geolocation
		document.addEventListener("deviceready", onDeviceReady, true);

        function onDeviceReady(){

        	if (navigator.notification) { // Override default HTML alert with native dialog
      	      window.alert = function (message) {
      		  		navigator.notification.alert(
      	              message,    // message
      	              null,       // callback
      	              "CAMS-AGC", // title
      	              'OK'        // buttonName
      	          );
      	      };
      	   }
        
          //alert("cari koordinat sebenar!");	
          navigator.geolocation.getCurrentPosition(onSuccess, onError);

        }  
        
        
        
        function onSuccess(position)
        {
            //alert("koordinat sebenar dijumpai");	
        	//alert("dapat value lat ===" + position.coords.latitude);
            //document.getElementById("latitud").innerHTML= position.coords.latitude;
            //document.getElementById("longitud").innerHTML= position.coords.longitude;
        	$('#latitud').val(position.coords.latitude);
        	$('#longitud').val(position.coords.longitude);
            
        }

        function onError(error) {
            //alert('code: ' + error.code + '\n' + 'message: ' + error.message + '\n');
            alert("Maaf, koordinat GPS anda tidak berjaya dikesan. Sila pastikan anda aktifkan GPS telefon pintar anda.");
        }
        
        function checkInByApplicant() 
		{
        	//alert("GLOBAL_IP==" + GLOBAL_IP);
        	//alert("nak simpan lat = " + $('#latitud').val());
         		//loading ("Sila tunggu...");
				var TX = Math.random(); 
				
                $.ajax({
                    url: GLOBAL_IP + "/api_generator.php?api_name=check_in_by_applicant&TX=" + TX,
                    dataType: "json",
					data: 
					{
						ph_id: gup("phid"),
						stf_username: $('#stf_username').val(),
						lat: $('#latitud').val(),
						lng: $('#longitud').val()
					},
					cache: false,
					timeout: 15 * 1000,
					error: function(xhr, textStatus, errorThrown){
						//alert('connection error ' + textStatus +  errorThrown ); 
						//unloading();
						alertError(1);
						return false;
					},
                    success: function(data) {
                    	//unloading();
                        alert('Lokasi anda berjaya dikemaskini.\nTerima kasih.');	
						window.location.href = "dashboard.html";
													
                    }
                });
			
        }   //end checkInByApplicant() 
				
        </script>

 
    </body>
</html>
