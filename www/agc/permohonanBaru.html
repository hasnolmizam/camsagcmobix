<!DOCTYPE HTML>
<html>
    <head>
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
		<title>AGC CAMS</title>
        <link rel="stylesheet" href="materialize/css/materialize.min.css" />
        <link rel="stylesheet" href="css/DateTimePicker.css" >
        <link rel="stylesheet" href="css/custom.css" >
		<script src='js/jquery2.1.0.min.js'></script>
        <script src="js/DateTimePicker.js"></script>
        <script src="js/custom.js"></script>
        <script src="materialize/js/materialize.min.js"></script>
		<script src="js/cams_script.js"></script>
		
		
    </head>

    <body>
    <script src="../cordova.js"></script>
        <div class="navbar-fixed">
            <nav class="deep-purple darken-1">
                <div class="nav-wrapper">
                    <div class="input-field">
                        <a href="" onclick="backPage()"><i class="mdi-navigation-chevron-left myBack"></i></a>
                        <img class="nav-logo" src="img/nav-logo.svg">
                        <label>Permohonan Baru</label>
                    </div>
                    <a href="#" data-activates="mobile-demo" class="button-collapse right"><i class="mdi-navigation-menu"></i></a>
                    <ul class="side-nav" id="mobile-demo">
                        <li class="profile-container"><div class="profile-background"></div><span class="profile-pic"></span>
						<span id="span_nama" name="span_nama" style="top: calc(50% - 10px);" class="profile-name"></span></li>
                        <li><a href="dashboard.html"><i class="mdi-action-home left"></i>Utama</a></li>
                        <li><a href="panduan.html"><i class="mdi-action-description left"></i>Panduan</a></li>
                        <li><a href="konfigurasi.html"><i class="mdi-action-settings left"></i>Konfigurasi</a></li>
                        <li><a href="javascript:;" onclick="logKeluar();"><i class="mdi-action-lock left"></i>Log Keluar</a></li>
                    </ul>
                    <ul class="side-nav hide-on-med-and-down tablet-nav">
                        <li class="profile-container"><div class="profile-background"></div><span class="profile-pic"></span>
						<span id="span_nama" name="span_nama" style="top: calc(50% - 10px);" class="profile-name"></span></li>
                        <li><a href="dashboard.html"><i class="mdi-action-home left"></i>Utama</a></li>
                        <li><a href="panduan.html"><i class="mdi-action-description left"></i>Panduan</a></li>
                        <li><a href="konfigurasi.html"><i class="mdi-action-settings left"></i>Konfigurasi</a></li>
                        <li><a href="javascript:;" onclick="logKeluar();"><i class="mdi-action-lock left"></i>Log Keluar</a></li>
                    </ul>
                </div>
            </nav>
        </div>

        <div class="myContainer">
            <div class="row">
                <div class="col s12">
                    <div class="card-panel myTitle">Permohonan Kebenaran Meninggalkan Pejabat Dalam Waktu Bekerja di Bawah Perintah AM 5 BAB G</div>
                    <div class="card-panel">
                        <form id="camsform" name="camsform" action="#">
                            <div class="row">
                                <div class="col s12 m2 label-on-small-only">Bahagian</div>
                                <div id="bahagian" name="bahagian" class="col s12 m5"></div>
                            </div>
                            <div id="penyokong" name="penyokong" class="row">
                                <div class="col s12 m2 label-on-small-only myInputAlign">Penyokong</div>
                                <div class="col s12 m5">
                                    <select id="stf_id_penyokong" name="stf_id_penyokong"></select>
                                </div>
                            </div>
							<div id="pelulus" name="pelulus" class="row">
                                <div class="col s12 m2 label-on-small-only myInputAlign">Pelulus</div>
                                <div class="col s12 m5">
                                    <select id="stf_id_pelulus" name="stf_id_pelulus"></select>
                                </div>
                            </div>   
                            <div class="row">
                                <div class="col s12 m2 label-on-small-only">Tujuan</div>
                                <div class="col s12 m10"><textarea id="tujuan" name="tujuan" class="materialize-textarea"></textarea></div>
                            </div>
                            <div class="row">
                                <div class="col s12 m2 label-on-small-only myInputAlign">Tarikh</div>
                                <div class="col s12 m5"><input id="tkh_keluar" name="tkh_keluar" type="text" data-field="date" required></div>
                            </div>
                            <div class="row">
                                <div class="col s12 m2 label-on-small-only myInputAlign">Masa Keluar</div>
                                <div class="col s12 m5"><input id="masa_keluar" name="masa_keluar" type="text" data-field="time" required></div>
                            </div>
                            <div class="row">
                                <div class="col s12 m2 label-on-small-only myInputAlign">Masa Masuk</div>
                                <div class="col s12 m5"><input id="masa_masuk" name="masa_masuk" type="text" data-field="time" required></div>
                            </div>
                            <div class="row">
                                <div class="col s12 m2 label-on-small-only myInputAlign">Lampiran</div>
                                <div class="col s12 m5 file-field">
                                    <input class="file-path" type="text" disabled/>
                                    <div class="btn waves-effect waves-light deep-purple darken-1">
                                        <span><i class="mdi-editor-attach-file"></i></span>
                                        <input type="file" />
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col s12 offset-m2 m10">
									<button class="btn-large waves-effect waves-light deep-purple darken-1 fullwidth" type="button" name="action" onclick="showConfirmHantar();">Hantar</button></div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div id="dtBox"></div>
		<span id="hidden"><input id="stf_username" name="stf_username" type="hidden"></span>
		
		    <script>
            $(document).ready(function(){
			  		
            	
            	document.addEventListener("backbutton", function(e){
		        	//if (!GLOBAL_MASUKLISTING)
		        	//	{
		        	//	logKeluar();
		        	//	}
		        	//else
		        	//	{
		        	//	closeListing();
		        	//	}
		        	//history.back();
		        	window.location.href="dashboard.html?nextpage=permohonan";
				 }, false);
		        
            	
            	
        		//alert('document saya dah ready di browser');
		      	  if (navigator.notification) { // Override default HTML alert with native dialog
		    	      
		      	      //alert('guna navigator.notification');
		      		  window.alert = function (message) {
		    	          navigator.notification.alert(
		    	              message,    // message
		    	              null,       // callback
		    	              "CAMS-AGC", // title
		    	              'OK'        // buttonName
		    	          );
		    	      };
		    	  }

		      	  
		      	  $(".button-collapse").sideNav({edge:'right'});
					
					getData();
					getApprover(getSessionStorage("PEN_BHGN_ID"));
					
					var today = new Date();

					$("#dtBox").DateTimePicker({timeFormat:'HH:mm', setButtonContent:'Set', clearButtonContent:'Padam', titleContentTime:'MASA', titleContentDate:'TARIKH', 
					  minDate: today.getDate()+'-'+(today.getMonth()+1)+'-'+today.getFullYear()
					}); //end dateTimePicker()

				   		
			});  //end document ready state
			          
			

	        document.addEventListener('deviceready', function () {
        	  if (navigator.notification) { // Override default HTML alert with native dialog
        	      window.alert = function (message) {
        		  		navigator.notification.alert(
        	              message,    // message
        	              null,       // callback
        	              "CAMS-AGC", // title
        	              'OK'        // buttonName
        	          );
        	      };
        	  }
        	}, false);
        	
			
			function getData()
			{
			
				var getFlowID = getSessionStorage("FLOW_ID");
			    if (getFlowID == 2) 
					{
						$("#penyokong").show();
						//alert('pengguna ini ada penyokong'); //ajax response successful alert box shows
						getSupporter(getSessionStorage("PEN_BHGN_ID"));
						
					}
					else 
					{
						$("#penyokong").hide();
					} 
					
				$('#span_nama').html (getSessionStorage("STF_NAMA"));
				$('#stf_username').val (getSessionStorage("STF_USERNAME"));
				$('#bahagian').html (getSessionStorage("BAHAGIAN"));
										
			
				var nicefilename = getSessionStorage("STF_GAMBAR_FILE");
				//alert(nicefilename);
				var urlgambar = "https://ilms.agc.gov.my/hrm/img/photos/" + nicefilename;
				$('.profile-background').css('background-image', 'url(' + urlgambar + ')');
				$('.profile-pic').css('background-image', 'url(' + urlgambar + ')');	
			}
			
		    		    
			function getSupporter(bhgnid) 
			{
         		//alert('start');
				var TX = Math.random(); 
		        //start ajax request
                $.ajax({
                    url: GLOBAL_IP + "/api_generator.php?TX=" + TX,
                    dataType: "json",
					data: 
					{
						api_name:"get_supporter_by_divisionid",
						bahagianid: bhgnid
					},
					cache: false,
					timeout: 15 * 1000,
					error: function(xhr, textStatus, errorThrown){
						//alert('connection error ' + textStatus +  errorThrown ); 
						alertError(1);
						return false;
					},
                    success: function(data) {
                        
                        //data downloaded so we call parseJSON function and pass downloaded data
                        //alert(data);
						var json = $.parseJSON(data);
						//alert('3='+ json.data);
						var jsondata = $.parseJSON(json.data);
						//alert('4=='+jsondata);
						//var jsondatadata = $.parseJSON(jsondata.data);
						//alert('jsondata.length===' + jsondata.length);
						var mytext = '<option value="" selected> Sila Pilih </option>';
						for(var i =0; i < jsondata.length; i++)		
						{
							mytext = mytext + '<option value="' + jsondata[i].STF_ID + '">' + jsondata[i].STF_NAMA + '</option>';
							
						}
												
						$('#stf_id_penyokong').html(mytext);
                        $('#stf_id_penyokong').material_select();						
							
							
                    }
                });
			
        }   
		
		
		function getApprover(bhgnid) 
		{
         		//alert('start');
				var TX = Math.random(); 
		        //start ajax request
                $.ajax({
                    url: GLOBAL_IP + "/api_generator.php?TX=" + TX,
                    dataType: "json",
					data: 
					{
						api_name:"get_approver_by_divisionid",
						bahagianid: bhgnid
					},
					cache: false,
					timeout: 15 * 1000,
					error: function(xhr, textStatus, errorThrown){
						//alert('connection error ' + textStatus +  errorThrown ); 
						alertError(1);
						return false;
					},
                    success: function(data) {
                        
                        //data downloaded so we call parseJSON function and pass downloaded data
                        //alert(data);
						var json = $.parseJSON(data);
						//alert('3='+ json.data);
						var jsondata = $.parseJSON(json.data);
						//alert('4=='+jsondata);
						//var jsondatadata = $.parseJSON(jsondata.data);
						//alert('jsondata.length===' + jsondata.length);
						var mytext = '<option value="" selected> Sila Pilih </option>';
						for(var i =0; i < jsondata.length; i++)		
						{
							mytext = mytext + '<option value="' + jsondata[i].STF_ID + '">' + jsondata[i].STF_NAMA + '</option>';
							
						}
												
						$('#stf_id_pelulus').html(mytext);
                        $('#stf_id_pelulus').material_select();						
													
                    }
                });
			
        }   //end getApprover()
		
		
		
		function submitApplication () 
		{
         		//alert('start');
         		loading("Permohonan anda sedang dihantar. Sila tunggu...");
				var TX = Math.random(); 
				//alert($('#stf_username').val());
				
                $.ajax({
                    url: GLOBAL_IP + "/api_generator.php?TX=" + TX,
                    dataType: "json",
					data: 
					{
						api_name:"save_application_by_applicant",
						stf_username: $('#stf_username').val(),
						stf_id_penyokong: $('#stf_id_penyokong').val(),
						stf_id_pelulus: $('#stf_id_pelulus').val(),
						tkh_keluar: $('#tkh_keluar').val(),
						masa_keluar: $('#masa_keluar').val(),
						masa_masuk: $('#masa_masuk').val(),
						tujuan: $('#tujuan').val()
					},
					cache: false,
					timeout: 15 * 1000,
					error: function(xhr, textStatus, errorThrown){
						unloading();
						//alert('connection error ' + textStatus +  errorThrown ); 
						alertError(1);
						return false;
					},
                    success: function(data) {
                    	unloading();
                        alert('Permohonan anda telah dihantar.\nTerima kasih.');	
						window.location.href = "dashboard.html";
													
                    }
                });
			
        }   //end getApprover()
		
        function showConfirmHantar() {
        	
        	//check dulu..
        	//============
        	var lengkap = true;
        	var kenaisi = "";
        	
        	var stf_id_penyokong = $('#stf_id_penyokong').val();
        	var stf_id_pelulus = $('#stf_id_pelulus').val();
        	var tujuan = $('#tujuan').val();
        	var tkh_keluar = $('#tkh_keluar').val();
        	var masa_keluar = $('#masa_keluar').val();
        	var masa_masuk = $('#masa_masuk').val();
        	
        	var getFlowID = getSessionStorage("FLOW_ID");
		    if (getFlowID == 2 && stf_id_penyokong == "")
		    {
		    	lengkap = false;
		    	kenaisi = "NAMA PENYOKONG";
		    }	
		    else if (stf_id_pelulus == "") { lengkap = false; kenaisi = "NAMA PELULUS"; }
		    else if (tujuan == "") { lengkap = false; kenaisi = "TUJUAN"; }
		    else if (tkh_keluar == "") { lengkap = false; kenaisi = "TARIKH KELUAR"; }
		    else if (masa_keluar == "") { lengkap = false; kenaisi = "MASA KELUAR"; }
		    else if (masa_masuk == "") { lengkap = false; kenaisi = "MASA MASUK";}
		    	
			if (lengkap)
				{
				
		        	navigator.notification.confirm(
		    			    "Adakah anda pasti untuk menghantar permohonan ini?",  // message
		    		        onConfirmHantar,                // callback to invoke with index of button pressed
		    		        "CAMS-AGC", // title
		    		        'YA,BATAL'          // buttonLabels
		    		    );
				
				}
			else
				{
					
				 	alert("Sila lengkapkan permohonan anda. Sila masukkan maklumat bagi [" + kenaisi + "]");
				}
		    	
        }

        
        function onConfirmHantar(buttonIndex) {
            //alert('You selected button ' + buttonIndex);
            if (buttonIndex == 1)
            	{
            	submitApplication();	
            	}
            
        }

        
        </script>

 
    </body>
</html>
